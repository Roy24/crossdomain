<html>
<head>	
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123456-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-123456-1');
</script>
	
	
<!-- End Google Analytics -->
<script>
	//Set the var that will be our setInterval function(needed to use clearInterval outside the function)
 var gSetInterval;
 //we need to create a function that will pass our parameters (otherwise setInterval won't pass the parameters)
 //a is the element, b is the src of the said element
	function gStartInterval(a,b) {
		//We define the interval and pass the parameters
    gSetInterval = setInterval(function(){ checkExist(a,b); }, 100);
	}
	//we check if Analytics is ready and modify the src
	function checkExist(a,b){
		//gobj contains Analytics functions
		var gobj = window[window.GoogleAnalyticsObject];
		//if it exists
		if (gobj){		
			var tracker, linker;
			//We get the current tracker
			tracker = gobj.getAll()[0];
			//we generate a new linker (for crossdomain)
			linker = new window.gaplugins.Linker(tracker);
			//we set the iFrame URL to the original src + the linker parameters
			a.src = linker.decorate(b);
			//stop the interval
		  clearInterval(gSetInterval);
	  } 
}
var gIframe = 'iframe', // Could be any selector
    targetHost = 'mymovietimeline'; //part of the hostname (to generate the parameters only on right iFrame)

// Lets generate our X-(wo)man
var gObserver = new MutationObserver(function(mutations){
	// For all the mutations
  for (var i=0; i < mutations.length; i++){
		// For all added nodes
    for (var j=0; j < mutations[i].addedNodes.length; j++){
      // we iterate through all the elements to check if there is an iFrame
      if (mutations[i].addedNodes[j].tagName == "IFRAME"){
				console.log(mutations[i].addedNodes[j].src);
				//If it's an iFrame, we check that the src contains the targeted hostname
        if (mutations[i].addedNodes[j].src.indexOf(targetHost) > -1) {
					(function () {
						//since the variable are attached in a loop, I need closure
						var a = mutations[i].addedNodes[j],
							b = mutations[i].addedNodes[j].src;
						mutations[i].addedNodes[j].src = ''; //we remove the src URL to avoid double tracking inside the Iframe
						gStartInterval(a,b); //we launch our star the interval function (to generate the full URL with the linker parameters we Analytics is ready)
					}()); // immediate invocation
					gObserver.disconnect(); // stop oberseving
				}
      }
    }
  }
});

//Our X-(wo)man will observe the DOM
gObserver.observe(document.documentElement, {
	//the X-(wo)man will only loop through the DOM
  childList: true,
  subtree: true
});
</script>
	
	
<title>CT test</title>
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>


</head>
<body>

	<button id="ct">Click me please</button>
	<iframe src="https://mymovietimeline.com">
		
	
	
</body>
</html>
